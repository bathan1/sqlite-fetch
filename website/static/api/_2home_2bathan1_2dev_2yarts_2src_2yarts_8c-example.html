<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yarts: /home/bathan1/dev/yarts/src/yarts.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">yarts
   </div>
   <div id="projectbrief">Yet Another Runtime TCP Stream (for SQLite)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/bathan1/dev/yarts/src/yarts.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">CREATE</span> VIRTUAL <span class="keyword">TABLE</span> todos <span class="keyword">using</span> <span class="keyword">fetch</span> (</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    url = <span class="stringliteral">&#39;https://jsonplaceholder.typicode.com/todos&#39;</span>,</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160; </div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    id <span class="keywordtype">int</span>,</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    <span class="stringliteral">&quot;userId&quot;</span> <span class="keywordtype">int</span>,</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    title text,</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    description text</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;);</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// Copyright 2025 Nathanael Oh. All Rights Reserved.</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="common_8h.html">common.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sqlite3ext.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line">SQLITE_EXTENSION_INIT1</div>
<div class="line"> </div>
<div class="line"><span class="comment">// uncomment to remove all debug prints</span></div>
<div class="line"><span class="preprocessor">#define NDEBUG</span></div>
<div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;yyjson.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;curl/curl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;wchar.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* utils */</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="fetch_8h.html">fetch.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef MIN</span></div>
<div class="line"><span class="preprocessor">#define MIN(a, b) (((a) &lt; (b)) ? (a) : (b))</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// arbitrary</span></div>
<div class="line"><span class="preprocessor">#define MAX_COLUMN_COUNT 128</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define FETCH_ARGS_OFFSET 3</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define FETCH_URL 0</span></div>
<div class="line"><span class="preprocessor">#define FETCH_BODY 1</span></div>
<div class="line"><span class="preprocessor">#define FETCH_HEADERS 2</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* For debug logs */</span></div>
<div class="line"><span class="preprocessor">#ifdef NDEBUG</span></div>
<div class="line"><span class="preprocessor">  #define println(...) do { } while (0)</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">  #define println(...)                     \</span></div>
<div class="line"><span class="preprocessor">    do {                                     \</span></div>
<div class="line"><span class="preprocessor">      printf(&quot;fetch-dbg&gt; &quot;</span> __VA_ARGS__);           \</div>
<div class="line">        printf(&quot;\n&quot;);\</div>
<div class="line">    } while (0)</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> debug_print_json(<span class="keyword">const</span> <span class="keywordtype">char</span> *label, yyjson_val *val) {</div>
<div class="line"><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line">    <span class="keywordtype">char</span> *s = yyjson_val_write(val, YYJSON_WRITE_PRETTY_TWO_SPACES, NULL);</div>
<div class="line">    <span class="keywordflow">if</span> (s) {</div>
<div class="line">        println(<span class="stringliteral">&quot;%s: %s&quot;</span>, label, s);</div>
<div class="line">        free(s);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        println(<span class="stringliteral">&quot;%s: &lt;null or non-serializable&gt;&quot;</span>, label);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> normalize_column_name(<span class="keywordtype">char</span> *<a class="code" href="common_8h.html#abf41691f50dd33bc178b7c1829b7d048">str</a>, <span class="keywordtype">int</span> *len) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="common_8h.html#abf41691f50dd33bc178b7c1829b7d048">str</a>[0] == <span class="charliteral">&#39;&quot;&#39;</span>) {</div>
<div class="line">        *len -= 2;</div>
<div class="line">        memmove(<a class="code" href="common_8h.html#abf41691f50dd33bc178b7c1829b7d048">str</a>, <a class="code" href="common_8h.html#abf41691f50dd33bc178b7c1829b7d048">str</a> + 1, *len);</div>
<div class="line">        <a class="code" href="common_8h.html#abf41691f50dd33bc178b7c1829b7d048">str</a>[*len] = 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keywordtype">int</span> status;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *text;</div>
<div class="line">} status_entry_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// map status int -&gt; status text</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> status_entry_t STATUS_TABLE[] = {</div>
<div class="line">    {200, <span class="stringliteral">&quot;OK&quot;</span>},</div>
<div class="line">    {201, <span class="stringliteral">&quot;Created&quot;</span>},</div>
<div class="line">    {202, <span class="stringliteral">&quot;Accepted&quot;</span>},</div>
<div class="line">    {204, <span class="stringliteral">&quot;No Content&quot;</span>},</div>
<div class="line">    {301, <span class="stringliteral">&quot;Moved Permanently&quot;</span>},</div>
<div class="line">    {302, <span class="stringliteral">&quot;Found&quot;</span>},</div>
<div class="line">    {400, <span class="stringliteral">&quot;Bad Request&quot;</span>},</div>
<div class="line">    {401, <span class="stringliteral">&quot;Unauthorized&quot;</span>},</div>
<div class="line">    {403, <span class="stringliteral">&quot;Forbidden&quot;</span>},</div>
<div class="line">    {404, <span class="stringliteral">&quot;Not Found&quot;</span>},</div>
<div class="line">    {500, <span class="stringliteral">&quot;Internal Server Error&quot;</span>},</div>
<div class="line">    {502, <span class="stringliteral">&quot;Bad Gateway&quot;</span>},</div>
<div class="line">    {503, <span class="stringliteral">&quot;Service Unavailable&quot;</span>},</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#define STATUS_TABLE_LEN sizeof(STATUS_TABLE) / sizeof(STATUS_TABLE[0])</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// lookup status text from static `STATUS_TABLE` from a status code</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *fetch_status_text(<span class="keywordtype">int</span> status) {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; STATUS_TABLE_LEN; ++i) {</div>
<div class="line">        <span class="keywordflow">if</span> (STATUS_TABLE[i].status == status)</div>
<div class="line">            <span class="keywordflow">return</span> STATUS_TABLE[i].text;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Unknown Status&quot;</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keywordtype">bool</span> is_hidden;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> generated_always_as_size;</div>
<div class="line">    <span class="keywordtype">size_t</span> *generated_always_as_len;</div>
<div class="line">    <span class="keywordtype">char</span> **generated_always_as;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> name_len;</div>
<div class="line">    <span class="keywordtype">char</span> *name;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> typename_len;</div>
<div class="line">    <span class="keywordtype">char</span> *<span class="keyword">typename</span>;</div>
<div class="line"> </div>
<div class="line">} column_def;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    sqlite3_vtab base;</div>
<div class="line"> </div>
<div class="line">    column_def **columns;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> columns_len;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> default_url_len;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">char</span> *default_url;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">char</span> *schema;</div>
<div class="line">} Fetch;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>fetch_cursor {</div>
<div class="line">    sqlite3_vtab_cursor base;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count;</div>
<div class="line">    <span class="keywordtype">int</span> sockfd;</div>
<div class="line">    <span class="keywordtype">int</span> eof;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Completed row (a fully constructed immutable doc)</span></div>
<div class="line">    yyjson_doc *next_doc;</div>
<div class="line">} fetch_cursor_t;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define X_UPDATE_OFFSET 2</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> is_key_url(<span class="keywordtype">char</span> *key) {</div>
<div class="line">    <span class="keywordflow">return</span> strncmp(<span class="stringliteral">&quot;url&quot;</span>, key, 3) == 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> is_key_body(<span class="keywordtype">char</span> *key) {</div>
<div class="line">    <span class="keywordflow">return</span> strncmp(<span class="stringliteral">&quot;body&quot;</span>, key, 4) == 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// For tokens &quot;fetch&quot; (module name), &quot;main&quot; (schema), &quot;patients&quot; (vtable name), and</span></div>
<div class="line"><span class="comment">// at least 1 argument for the url argument</span></div>
<div class="line"><span class="preprocessor">#define MIN_ARGC 4</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// &quot;fetch&quot;, &quot;{schema}&quot;, &quot;{vtable_name}&quot;, &quot;{?url}&quot;, &quot;{?body}&quot;, </span></div>
<div class="line"><span class="comment">// &quot;{?headers}&quot;, ... optional static column declarations</span></div>
<div class="line"><span class="preprocessor">#define MAX_FETCH_ARGC 6</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> index_of_key(<span class="keywordtype">char</span> *key) {</div>
<div class="line">    <span class="keywordflow">if</span> (is_key_url(key)) {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_key_body(key)) {</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">// headers</span></div>
<div class="line">        <span class="keywordflow">return</span> 2;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> yyjson_doc *array_wrap(yyjson_val *val) {</div>
<div class="line">    yyjson_mut_doc *mdoc = yyjson_mut_doc_new(NULL);</div>
<div class="line">    yyjson_mut_val *arr = yyjson_mut_arr(mdoc);</div>
<div class="line">    yyjson_mut_doc_set_root(mdoc, arr);</div>
<div class="line"> </div>
<div class="line">    yyjson_mut_val *copied = yyjson_val_mut_copy(mdoc, val);</div>
<div class="line">    yyjson_mut_arr_add_val(arr, copied);</div>
<div class="line">    yyjson_doc *im_doc = yyjson_mut_doc_imut_copy(mdoc, NULL);</div>
<div class="line">    yyjson_mut_doc_free(mdoc);</div>
<div class="line">    <span class="keywordflow">return</span> im_doc;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// id int [default] [default_val]</span></div>
<div class="line"><span class="comment">// id int [generated] [always] [as] ([generated_val])</span></div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">    <span class="comment">// id</span></div>
<div class="line">    COL_NAME = 0,</div>
<div class="line">    <span class="comment">// int</span></div>
<div class="line">    COL_TYPE,</div>
<div class="line">    <span class="comment">// generated</span></div>
<div class="line">    COL_CST,</div>
<div class="line">    <span class="comment">// always</span></div>
<div class="line">    COL_CST_VAL,</div>
<div class="line">    <span class="comment">// as</span></div>
<div class="line">    COL_CST_VAL2,</div>
<div class="line">    <span class="comment">// ([generated_val])</span></div>
<div class="line">    COL_GEN_CST_VAL</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">column_def **init_columns(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv) {</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> has_url_column = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = FETCH_ARGS_OFFSET; i &lt; argc; i++) {</div>
<div class="line">        <span class="comment">// argv[i] is one column definition</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *arg = argv[i];</div>
<div class="line">        <span class="keywordtype">int</span> tokens_size = 0;</div>
<div class="line">        <span class="keywordtype">int</span> token_len[8];</div>
<div class="line">        <span class="keywordtype">char</span> **tokens = split(arg, <span class="charliteral">&#39; &#39;</span>, &amp;tokens_size, token_len);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (tokens_size &gt; 0 &amp;&amp;</div>
<div class="line">            token_len[COL_NAME] == 3 &amp;&amp;</div>
<div class="line">            strncmp(tokens[COL_NAME], <span class="stringliteral">&quot;url&quot;</span>, 3) == 0) {</div>
<div class="line">            has_url_column = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = 0; t &lt; tokens_size; t++) free(tokens[t]);</div>
<div class="line">        free(tokens);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> num_columns = (argc - FETCH_ARGS_OFFSET)</div>
<div class="line">                      + (!has_url_column ? 1 : 0);</div>
<div class="line"> </div>
<div class="line">    column_def **columns = malloc(<span class="keyword">sizeof</span>(column_def*) * num_columns);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// index 0 is always url</span></div>
<div class="line">    column_def *url = calloc(1, <span class="keyword">sizeof</span>(column_def));</div>
<div class="line">    url-&gt;is_hidden = <span class="keyword">true</span>;</div>
<div class="line">    url-&gt;name = strdup(<span class="stringliteral">&quot;url&quot;</span>);</div>
<div class="line">    url-&gt;name_len = 3;</div>
<div class="line">    url-&gt;typename = strdup(<span class="stringliteral">&quot;text&quot;</span>);</div>
<div class="line">    url-&gt;typename_len = 4;</div>
<div class="line">    columns[0] = url;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> columns;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> split_generated_path(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *expr,</div>
<div class="line">    <span class="keywordtype">size_t</span> expr_len,</div>
<div class="line">    <span class="keywordtype">char</span> ***out_parts,</div>
<div class="line">    <span class="keywordtype">size_t</span> **out_lens,</div>
<div class="line">    <span class="keywordtype">size_t</span> *out_count</div>
<div class="line">) {</div>
<div class="line">    <span class="comment">// 1. Count segments</span></div>
<div class="line">    <span class="keywordtype">size_t</span> count = 1;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i + 1 &lt; expr_len; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (expr[i] == <span class="charliteral">&#39;-&#39;</span> &amp;&amp; expr[i+1] == <span class="charliteral">&#39;&gt;&#39;</span>) {</div>
<div class="line">            count++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">char</span> **parts = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*) * count);</div>
<div class="line">    <span class="keywordtype">size_t</span> *lens = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">size_t</span>) * count);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> start = 0;</div>
<div class="line">    <span class="keywordtype">size_t</span> idx = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt;= expr_len; i++) {</div>
<div class="line">        <span class="keywordtype">bool</span> at_arrow =</div>
<div class="line">            (i + 1 &lt; expr_len &amp;&amp; expr[i] == <span class="charliteral">&#39;-&#39;</span> &amp;&amp; expr[i+1] == <span class="charliteral">&#39;&gt;&#39;</span>);</div>
<div class="line">        <span class="keywordtype">bool</span> at_end = (i == expr_len);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (at_arrow || at_end) {</div>
<div class="line">            <span class="keywordtype">size_t</span> seg_len = i - start;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">//</span></div>
<div class="line">            <span class="comment">// First strip *quotes*</span></div>
<div class="line">            <span class="comment">//</span></div>
<div class="line">            <span class="keywordtype">char</span> *tmp = remove_all(expr + start, &amp;seg_len, <span class="charliteral">&#39;\&#39;&#39;</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">//</span></div>
<div class="line">            <span class="comment">// Then strip newlines and carriage returns</span></div>
<div class="line">            <span class="comment">//</span></div>
<div class="line">            <span class="keywordtype">size_t</span> cleaned_len = seg_len;</div>
<div class="line">            tmp = remove_all(tmp, &amp;cleaned_len, <span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">            tmp = remove_all(tmp, &amp;cleaned_len, <span class="charliteral">&#39;\r&#39;</span>);</div>
<div class="line"> </div>
<div class="line">            parts[idx] = tmp;</div>
<div class="line">            lens[idx] = cleaned_len;</div>
<div class="line">            idx++;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (at_arrow) {</div>
<div class="line">                i++;</div>
<div class="line">                start = i + 1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    *out_parts = parts;</div>
<div class="line">    *out_lens = lens;</div>
<div class="line">    *out_count = count;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> Fetch *fetch_alloc(sqlite3 *db, <span class="keywordtype">int</span> argc,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv)</div>
<div class="line">{</div>
<div class="line">    Fetch *vtab = sqlite3_malloc(<span class="keyword">sizeof</span>(Fetch));</div>
<div class="line">    <span class="keywordflow">if</span> (!vtab) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;sqlite3_malloc() out of memory\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    memset(vtab, 0, <span class="keyword">sizeof</span>(Fetch));</div>
<div class="line">    vtab-&gt;columns = init_columns(argc, argv);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> index = 1;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = FETCH_ARGS_OFFSET; i &lt; argc; i++) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *arg = argv[i];</div>
<div class="line">        <span class="keywordtype">int</span> tokens_size = 0;</div>
<div class="line">        <span class="keywordtype">int</span> token_len[6] = {0};</div>
<div class="line">        <span class="keywordtype">char</span> **token = split(arg, <span class="charliteral">&#39; &#39;</span>, &amp;tokens_size, token_len);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; tokens_size - 1; i++) {</div>
<div class="line">            <span class="keywordtype">char</span> *prev = token[i];</div>
<div class="line">            token[i] = to_lower(prev, token_len[i]);</div>
<div class="line">            free(prev);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (</div>
<div class="line">            token_len[COL_NAME] == 3 &amp;&amp;</div>
<div class="line">            strncmp(token[COL_NAME], <span class="stringliteral">&quot;url&quot;</span>, 3) == 0</div>
<div class="line">            &amp;&amp;</div>
<div class="line">            token_len[COL_CST] == 7 &amp;&amp; </div>
<div class="line">            strncmp(token[COL_CST], <span class="stringliteral">&quot;default&quot;</span>, 7) == 0</div>
<div class="line">        ) {</div>
<div class="line">            vtab-&gt;default_url_len = token_len[COL_CST_VAL];</div>
<div class="line">            vtab-&gt;default_url = remove_all(token[COL_CST_VAL], &amp;vtab-&gt;default_url_len, <span class="charliteral">&#39;\&#39;&#39;</span>);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        normalize_column_name(token[COL_NAME], &amp;token_len[COL_NAME]);</div>
<div class="line">        column_def *def = calloc(1, <span class="keyword">sizeof</span>(column_def));</div>
<div class="line">        def-&gt;name = token[COL_NAME];</div>
<div class="line">        def-&gt;name_len = token_len[COL_NAME];</div>
<div class="line">        def-&gt;typename = token[COL_TYPE];</div>
<div class="line">        def-&gt;typename_len = token_len[COL_TYPE];</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (</div>
<div class="line">            token_len[COL_CST] == 9 &amp;&amp;</div>
<div class="line">            strncmp(token[COL_CST], <span class="stringliteral">&quot;generated&quot;</span>, 9) == 0</div>
<div class="line">            &amp;&amp;</div>
<div class="line">            token_len[COL_CST_VAL] == 6 &amp;&amp;</div>
<div class="line">            strncmp(token[COL_CST_VAL], <span class="stringliteral">&quot;always&quot;</span>, 6) == 0</div>
<div class="line">            &amp;&amp;</div>
<div class="line">            token_len[COL_CST_VAL2] == 2 &amp;&amp;</div>
<div class="line">            strncmp(token[COL_CST_VAL2], <span class="stringliteral">&quot;as&quot;</span>, 2) == 0</div>
<div class="line">            &amp;&amp;</div>
<div class="line">            token_len[COL_GEN_CST_VAL] &gt; 0</div>
<div class="line">        ) {</div>
<div class="line">            <span class="keywordtype">char</span> *expr_raw = token[COL_GEN_CST_VAL];</div>
<div class="line">            <span class="keywordtype">size_t</span> expr_len = token_len[COL_GEN_CST_VAL];</div>
<div class="line">            <span class="keywordflow">if</span> (expr_len &gt;= 2 &amp;&amp; expr_raw[0] == <span class="charliteral">&#39;(&#39;</span> &amp;&amp; expr_raw[expr_len - 1] == <span class="charliteral">&#39;)&#39;</span>) {</div>
<div class="line">                expr_raw++;           <span class="comment">// move start</span></div>
<div class="line">                expr_len -= 2;        <span class="comment">// remove both &#39;(&#39; and &#39;)&#39;</span></div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* make a real owned copy */</span></div>
<div class="line">            <span class="keywordtype">char</span> *expr = malloc(expr_len + 1);</div>
<div class="line">            memcpy(expr, expr_raw, expr_len);</div>
<div class="line">            expr[expr_len] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">char</span> **parts;</div>
<div class="line">            <span class="keywordtype">size_t</span> *lens;</div>
<div class="line">            <span class="keywordtype">size_t</span> count;</div>
<div class="line"> </div>
<div class="line">            split_generated_path(expr, expr_len, &amp;parts, &amp;lens, &amp;count);</div>
<div class="line"> </div>
<div class="line">            def-&gt;generated_always_as = parts;</div>
<div class="line">            def-&gt;generated_always_as_len = lens;</div>
<div class="line">            def-&gt;generated_always_as_size = count;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        vtab-&gt;columns[index++] = def;</div>
<div class="line">    }</div>
<div class="line">    vtab-&gt;columns_len = index;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* max number of tokens valid inside a single xCreate argument for the table declaration */</span></div>
<div class="line">    <span class="keywordtype">int</span> MAX_ARG_TOKENS = 2;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *table_name = argv[2];</div>
<div class="line">    <span class="keywordtype">char</span> *first_line = string(<span class="stringliteral">&quot;CREATE TABLE %s(url hidden text,&quot;</span>, table_name);</div>
<div class="line">    sqlite3_str *s = sqlite3_str_new(db);</div>
<div class="line">    sqlite3_str_appendall(s, first_line + <span class="keyword">sizeof</span>(<span class="keywordtype">size_t</span>));</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; vtab-&gt;columns_len; i++) {</div>
<div class="line">        column_def *def = vtab-&gt;columns[i];</div>
<div class="line">        sqlite3_str_appendf(s, <span class="stringliteral">&quot;%s %s&quot;</span>, def-&gt;name, def-&gt;typename);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (i + 1 &lt; vtab-&gt;columns_len)</div>
<div class="line">            sqlite3_str_appendall(s, <span class="stringliteral">&quot;,&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    sqlite3_str_appendall(s, <span class="stringliteral">&quot;)&quot;</span>);</div>
<div class="line">    vtab-&gt;schema = sqlite3_str_finish(s);</div>
<div class="line">    free(first_line);</div>
<div class="line"> </div>
<div class="line">    println(<span class="stringliteral">&quot;schema: %s&quot;</span>, vtab-&gt;schema);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> vtab;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xConnect(sqlite3 *pdb, <span class="keywordtype">void</span> *paux, <span class="keywordtype">int</span> argc,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv, sqlite3_vtab **pp_vtab,</div>
<div class="line">                     <span class="keywordtype">char</span> **pz_err) {</div>
<div class="line">    <span class="keywordflow">if</span> (argc &lt; MIN_ARGC) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Expected %d args but got %d args\n&quot;</span>, MIN_ARGC, argc);</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">int</span> rc = SQLITE_OK;</div>
<div class="line">    *pp_vtab = (sqlite3_vtab *) fetch_alloc(pdb, argc, argv);</div>
<div class="line">    Fetch *vtab = (Fetch *) *pp_vtab;</div>
<div class="line">    <span class="keywordflow">if</span> (!vtab) { </div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_NOMEM;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rc += sqlite3_declare_vtab(pdb, vtab-&gt;schema);</div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xCreate(sqlite3 *pdb, <span class="keywordtype">void</span> *paux, <span class="keywordtype">int</span> argc,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv, sqlite3_vtab **pp_vtab,</div>
<div class="line">                     <span class="keywordtype">char</span> **pz_err) {</div>
<div class="line">    <span class="comment">// same implementation as xConnect, we just </span></div>
<div class="line">    <span class="comment">// have to point to different fns so this isn&#39;t eponymous (can&#39;t be called</span></div>
<div class="line">    <span class="comment">// as its own table e.g. SELECT * FROM fetch)</span></div>
<div class="line">    <span class="keywordflow">return</span> xConnect(pdb, paux, argc, argv, pp_vtab, pz_err);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/* To inline index checkers for x_index() */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> is_url_set_index_constraint(<span class="keyword">struct</span> sqlite3_index_constraint *cst) {</div>
<div class="line">    <span class="keywordflow">return</span> (</div>
<div class="line">        cst-&gt;iColumn == FETCH_URL <span class="comment">// column index</span></div>
<div class="line">        &amp;&amp; cst-&gt;op == <span class="comment">// was the operator &#39;=&#39;?</span></div>
<div class="line">            SQLITE_INDEX_CONSTRAINT_EQ</div>
<div class="line">        &amp;&amp; cst-&gt;usable</div>
<div class="line">    );</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#define IS_CST_HEADERS_EQ(cst) (cst-&gt;iColumn == FETCH_HEADERS &amp;&amp; cst-&gt;op == SQLITE_INDEX_CONSTRAINT_EQ &amp;&amp; cst-&gt;usable)</span></div>
<div class="line"><span class="comment">/* expected bitmask value of the index_info from xBestIndex */</span></div>
<div class="line"><span class="preprocessor">#define REQUIRED_BITS 0b01</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> check_plan_mask(<span class="keyword">struct</span> sqlite3_index_info *index_info,</div>
<div class="line">                           sqlite3_vtab *pVtab) {</div>
<div class="line">    <span class="keywordflow">if</span> ((index_info-&gt;idxNum &amp; REQUIRED_BITS) == REQUIRED_BITS)</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> is_url_eq_cst = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; index_info-&gt;nConstraint; i++) {</div>
<div class="line">        <span class="keyword">struct </span>sqlite3_index_constraint *cst = &amp;index_info-&gt;aConstraint[i];</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cst-&gt;iColumn == FETCH_URL) {</div>
<div class="line">            <span class="comment">// User passed in a &quot;url&quot; constraint, just not a usable one</span></div>
<div class="line">            is_url_eq_cst = 1;</div>
<div class="line">            <span class="keywordflow">if</span> (!cst-&gt;usable) {</div>
<div class="line">                <span class="keywordflow">return</span> SQLITE_CONSTRAINT;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!is_url_eq_cst) {</div>
<div class="line">        Fetch *vtab = (<span class="keywordtype">void</span> *) pVtab;</div>
<div class="line">        <span class="keywordflow">if</span> (!vtab-&gt;default_url || vtab-&gt;default_url_len == 0) {</div>
<div class="line">            pVtab-&gt;zErrMsg = sqlite3_mprintf(</div>
<div class="line">                <span class="stringliteral">&quot;fetch SELECT needs a `WHERE url = &#39;something&#39;` clause when no default url is set.\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xBestIndex(sqlite3_vtab *pVTab, sqlite3_index_info *pIdxInfo) {</div>
<div class="line">    <span class="keywordtype">int</span> argPos = 1;</div>
<div class="line">    <span class="keywordtype">int</span> planMask = 0;</div>
<div class="line">    Fetch *vtab = (Fetch *)pVTab;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; pIdxInfo-&gt;nConstraint; i++) {</div>
<div class="line">        <span class="keyword">struct </span>sqlite3_index_constraint *cst = &amp;pIdxInfo-&gt;aConstraint[i];</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!cst-&gt;usable || cst-&gt;op != SQLITE_INDEX_CONSTRAINT_EQ)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">struct </span>sqlite3_index_constraint_usage *usage =</div>
<div class="line">            &amp;pIdxInfo-&gt;aConstraintUsage[i];</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (is_url_set_index_constraint(cst)) {</div>
<div class="line">            usage-&gt;omit = 1;</div>
<div class="line">            usage-&gt;argvIndex = argPos++;</div>
<div class="line">            planMask |= 0b01;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    pIdxInfo-&gt;idxNum = planMask;</div>
<div class="line">    <span class="keywordflow">return</span> check_plan_mask(pIdxInfo, pVTab);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xDisconnect(sqlite3_vtab *pvtab) {</div>
<div class="line">    println(<span class="stringliteral">&quot;xDisconnect begin&quot;</span>);</div>
<div class="line">    Fetch *vtab = (Fetch *) pvtab;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; vtab-&gt;columns_len; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (vtab-&gt;columns[i]) {</div>
<div class="line">            <span class="keywordflow">if</span> (vtab-&gt;columns[i]-&gt;name) {</div>
<div class="line">                free(vtab-&gt;columns[i]-&gt;name);</div>
<div class="line">                vtab-&gt;columns[i]-&gt;name = 0;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (vtab-&gt;columns[i]-&gt;typename) {</div>
<div class="line">                free(vtab-&gt;columns[i]-&gt;typename);</div>
<div class="line">                vtab-&gt;columns[i]-&gt;typename = 0;</div>
<div class="line">            }</div>
<div class="line">            free(vtab-&gt;columns[i]);</div>
<div class="line">            vtab-&gt;columns[i] = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    free(vtab-&gt;columns);</div>
<div class="line">    vtab-&gt;columns = 0;</div>
<div class="line">    vtab-&gt;columns_len = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vtab-&gt;default_url_len &gt; 0 &amp;&amp; vtab-&gt;default_url) {</div>
<div class="line">        free(vtab-&gt;default_url);</div>
<div class="line">        vtab-&gt;default_url_len = 0;</div>
<div class="line">        vtab-&gt;default_url = 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    sqlite3_free(vtab-&gt;schema);</div>
<div class="line">    sqlite3_free(pvtab);</div>
<div class="line">    println(<span class="stringliteral">&quot;xDisconnect end&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xOpen(sqlite3_vtab *pvtab, sqlite3_vtab_cursor **pp_cursor) {</div>
<div class="line">    Fetch *<a name="a0"></a><a class="code" href="fetch_8h.html#ae2ade91c016425d325d49524ff3a218a">fetch</a> = (Fetch *) pvtab;</div>
<div class="line">    fetch_cursor_t *cur = sqlite3_malloc(<span class="keyword">sizeof</span>(fetch_cursor_t));</div>
<div class="line">    <span class="keywordflow">if</span> (!cur) {</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_NOMEM;</div>
<div class="line">    }</div>
<div class="line">    memset(cur, 0, <span class="keyword">sizeof</span>(fetch_cursor_t));</div>
<div class="line"> </div>
<div class="line">    cur-&gt;count = 0;</div>
<div class="line"> </div>
<div class="line">    *pp_cursor = (sqlite3_vtab_cursor *)cur;</div>
<div class="line">    (*pp_cursor)-&gt;pVtab = pvtab;</div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xClose(sqlite3_vtab_cursor *cur) {</div>
<div class="line">    println(<span class="stringliteral">&quot;xClose begin&quot;</span>);</div>
<div class="line">    fetch_cursor_t *cursor = (fetch_cursor_t *)cur;</div>
<div class="line">    <span class="keywordflow">if</span> (cursor) {</div>
<div class="line">        <span class="keywordflow">if</span> (cursor-&gt;next_doc) {</div>
<div class="line">            yyjson_doc_free(cursor-&gt;next_doc);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (cursor-&gt;sockfd &gt; 0) {</div>
<div class="line">            close(cursor-&gt;sockfd);</div>
<div class="line">        }</div>
<div class="line">        sqlite3_free(cur);</div>
<div class="line">    }</div>
<div class="line">    println(<span class="stringliteral">&quot;xClose end&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xNext(sqlite3_vtab_cursor *cur0) {</div>
<div class="line">    fetch_cursor_t *cur = (fetch_cursor_t*)cur0;</div>
<div class="line">    Fetch *vtab = (<span class="keywordtype">void</span>*) cur-&gt;base.pVtab;</div>
<div class="line"> </div>
<div class="line">    println(<span class="stringliteral">&quot;xNext (%u -&gt; %u) begin&quot;</span>, cur-&gt;count, cur-&gt;count + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Sanity: next_doc must always contain the row returned previously.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!cur-&gt;next_doc) {</div>
<div class="line">        vtab-&gt;base.zErrMsg = sqlite3_mprintf(</div>
<div class="line">            <span class="stringliteral">&quot;unexpected NULL next_doc in cursor&quot;</span></div>
<div class="line">        );</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ---------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// Save previous row so we can free it *after* we load next</span></div>
<div class="line">    <span class="comment">// ---------------------------------------------------------</span></div>
<div class="line">    yyjson_doc *prev = cur-&gt;next_doc;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ---------------------------------------------------------</span></div>
<div class="line">    <span class="comment">// 1. Try to get next doc immediately from clarinet queue</span></div>
<div class="line">    <span class="comment">// ---------------------------------------------------------</span></div>
<div class="line">    <span class="keywordtype">size_t</span> size = 0;</div>
<div class="line">    <span class="keywordtype">char</span> *doc_text = <a name="a1"></a><a class="code" href="fetch_8h.html#a585dd7049ee255d6147a22aee62a6b91">fetch_pop</a>(cur-&gt;sockfd, &amp;size);</div>
<div class="line">    <span class="keywordflow">if</span> (doc_text) {</div>
<div class="line">        yyjson_doc *doc = yyjson_read(doc_text, size, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (!doc) {</div>
<div class="line">            cur-&gt;base.pVtab-&gt;zErrMsg =</div>
<div class="line">                sqlite3_mprintf(<span class="stringliteral">&quot;malformed JSON in clarinet queue&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// NOW FREE the previous row</span></div>
<div class="line">        yyjson_doc_free(prev);</div>
<div class="line"> </div>
<div class="line">        cur-&gt;next_doc = doc;</div>
<div class="line">        cur-&gt;count++;</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    yyjson_doc_free(prev);</div>
<div class="line">    cur-&gt;next_doc = NULL; <span class="comment">// So xEof knows we&#39;re done</span></div>
<div class="line">    println(<span class="stringliteral">&quot;xNext end: no more rows&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> json_bool_result(</div>
<div class="line">    sqlite3_context *pctx,</div>
<div class="line">    column_def *def,</div>
<div class="line">    yyjson_val *column_val</div>
<div class="line">) {</div>
<div class="line">    <span class="keywordflow">if</span> (strncmp(def-&gt;typename, <span class="stringliteral">&quot;int&quot;</span>, 3) == 0 || strncmp(def-&gt;typename, <span class="stringliteral">&quot;float&quot;</span>, 5) == 0) {</div>
<div class="line">        sqlite3_result_int(pctx, yyjson_get_bool(column_val));</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        sqlite3_result_text(pctx, yyjson_get_bool(column_val) ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>, -1, SQLITE_TRANSIENT);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> yyjson_val *follow_generated_path(</div>
<div class="line">    yyjson_val *root,</div>
<div class="line">    <span class="keywordtype">char</span> **keys,</div>
<div class="line">    <span class="keywordtype">size_t</span> *lens,</div>
<div class="line">    <span class="keywordtype">size_t</span> count</div>
<div class="line">) {</div>
<div class="line">    yyjson_val *cur = root;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; count; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (!cur || yyjson_get_type(cur) != YYJSON_TYPE_OBJ) {</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// keys[i] is already null-terminated</span></div>
<div class="line">        cur = yyjson_obj_getn(cur, keys[i], lens[i]);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> cur;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xColumn(sqlite3_vtab_cursor *pcursor,</div>
<div class="line">                    sqlite3_context *pctx,</div>
<div class="line">                    <span class="keywordtype">int</span> icol)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// println(&quot;xColumn(column = %d)&quot;, icol);</span></div>
<div class="line"> </div>
<div class="line">    fetch_cursor_t *cursor = (fetch_cursor_t *)pcursor;</div>
<div class="line">    Fetch *vtab = (<span class="keywordtype">void</span> *) cursor-&gt;base.pVtab;</div>
<div class="line"> </div>
<div class="line">    if (!cursor-&gt;next_doc) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;expected a JSON pointer in next_doc but got 0\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    column_def *def = vtab-&gt;columns[icol];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (def-&gt;is_hidden) {</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    yyjson_val *val = yyjson_doc_get_root(cursor-&gt;next_doc);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (def-&gt;generated_always_as_size &gt; 0) {</div>
<div class="line">        val = follow_generated_path(</div>
<div class="line">            val,</div>
<div class="line">            def-&gt;generated_always_as,</div>
<div class="line">            def-&gt;generated_always_as_len,</div>
<div class="line">            def-&gt;generated_always_as_size);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        val = yyjson_obj_getn(val, def-&gt;name, def-&gt;name_len);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!val) {</div>
<div class="line">        sqlite3_result_null(pctx);</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (yyjson_get_type(val)) {</div>
<div class="line">    <span class="keywordflow">case</span> YYJSON_TYPE_STR:</div>
<div class="line">        sqlite3_result_text(pctx, yyjson_get_str(val), -1, SQLITE_TRANSIENT);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> YYJSON_TYPE_NUM:</div>
<div class="line">        sqlite3_result_int(pctx, yyjson_get_int(val));</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> YYJSON_TYPE_BOOL:</div>
<div class="line">        json_bool_result(pctx, def, val);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> YYJSON_TYPE_OBJ:</div>
<div class="line">    <span class="keywordflow">case</span> YYJSON_TYPE_ARR: {</div>
<div class="line">        <span class="keywordtype">char</span> *json = yyjson_val_write(val, 0, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (json) {</div>
<div class="line">            sqlite3_result_text(pctx, json, -1, SQLITE_TRANSIENT);</div>
<div class="line">            free(json);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            sqlite3_result_null(pctx);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        sqlite3_result_null(pctx);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// println(&quot;xColumn end&quot;);</span></div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xEof(sqlite3_vtab_cursor *cur) {</div>
<div class="line">    fetch_cursor_t *c = (fetch_cursor_t*)cur;</div>
<div class="line">    <span class="keywordtype">int</span> rc = c-&gt;next_doc == NULL;</div>
<div class="line">    println(<span class="stringliteral">&quot;xEof end %s&quot;</span>, rc == 1 ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xRowid(sqlite3_vtab_cursor *pcursor, sqlite3_int64 *prowid) {</div>
<div class="line">    *prowid = ((fetch_cursor_t *)pcursor)-&gt;count;</div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xFilter(sqlite3_vtab_cursor *cur0,</div>
<div class="line">                    <span class="keywordtype">int</span> idxNum, <span class="keyword">const</span> <span class="keywordtype">char</span> *idxStr,</div>
<div class="line">                    <span class="keywordtype">int</span> argc, sqlite3_value **argv)</div>
<div class="line">{</div>
<div class="line">    println(<span class="stringliteral">&quot;xFilter begin&quot;</span>);</div>
<div class="line">    Fetch *vtab = (Fetch*)cur0-&gt;pVtab;</div>
<div class="line">    fetch_cursor_t *Cur = (fetch_cursor_t*)cur0;</div>
<div class="line"> </div>
<div class="line">    Cur-&gt;eof       = 0;</div>
<div class="line">    Cur-&gt;count     = 0;</div>
<div class="line">    Cur-&gt;next_doc  = NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Extract URL</span></div>
<div class="line">    <span class="keywordflow">if</span> (argc + vtab-&gt;default_url_len == 0) {</div>
<div class="line">        cur0-&gt;pVtab-&gt;zErrMsg =</div>
<div class="line">            sqlite3_mprintf(<span class="stringliteral">&quot;fetch: need at least 1 argument or default url&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *argurl = (argc &gt; 0)</div>
<div class="line">        ? (<span class="keyword">const</span> <span class="keywordtype">char</span>*)sqlite3_value_text(argv[0])</div>
<div class="line">        : vtab-&gt;default_url;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> sz = strlen(argurl);</div>
<div class="line">    <span class="keywordtype">char</span> *url = remove_all(argurl, &amp;sz, <span class="charliteral">&#39;\&#39;&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!url) url = strdup(vtab-&gt;default_url);</div>
<div class="line"> </div>
<div class="line">    Cur-&gt;sockfd = <a class="code" href="fetch_8h.html#ae2ade91c016425d325d49524ff3a218a">fetch</a>(url, (<a name="_a2"></a><a class="code" href="structfetch__init.html">fetch_init_t</a>) {0});</div>
<div class="line">    free(url);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (Cur-&gt;sockfd &lt; 0) {</div>
<div class="line">        cur0-&gt;pVtab-&gt;zErrMsg =</div>
<div class="line">            sqlite3_mprintf(<span class="stringliteral">&quot;fetch: could not connect\n&quot;</span>);</div>
<div class="line">        Cur-&gt;eof = 1;</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> first_length = 0;</div>
<div class="line">    <span class="keywordtype">char</span> *popped = <a class="code" href="fetch_8h.html#a585dd7049ee255d6147a22aee62a6b91">fetch_pop</a>(Cur-&gt;sockfd, &amp;first_length);</div>
<div class="line">    <span class="keywordflow">if</span> (!popped) {</div>
<div class="line">        cur0-&gt;pVtab-&gt;zErrMsg =</div>
<div class="line">            sqlite3_mprintf(<span class="stringliteral">&quot;fetch: empty body\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> SQLITE_ERROR;</div>
<div class="line">    }</div>
<div class="line">    yyjson_doc *doc = yyjson_read(popped, first_length, 0);</div>
<div class="line">    Cur-&gt;next_doc = doc;</div>
<div class="line"> </div>
<div class="line">    println(<span class="stringliteral">&quot;xFilter end&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> SQLITE_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> sqlite3_module fetch_vtab_module = {</div>
<div class="line">    .iVersion=0,</div>
<div class="line">    .xCreate=xCreate,</div>
<div class="line">    .xConnect=xConnect,</div>
<div class="line">    .xBestIndex=xBestIndex,</div>
<div class="line">    .xDisconnect=xDisconnect,</div>
<div class="line">    .xDestroy=xDisconnect,</div>
<div class="line">    .xOpen=xOpen,</div>
<div class="line">    .xClose=xClose,</div>
<div class="line">    .xFilter=xFilter,</div>
<div class="line">    .xNext=xNext,</div>
<div class="line">    .xEof=xEof,</div>
<div class="line">    .xColumn=xColumn,</div>
<div class="line">    .xRowid=xRowid,</div>
<div class="line">    .xUpdate=NULL,</div>
<div class="line">    .xBegin=NULL,</div>
<div class="line">    .xSync=NULL,</div>
<div class="line">    .xCommit=NULL,</div>
<div class="line">    .xRollback=NULL,</div>
<div class="line">    .xFindFunction=NULL</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Runtime loadable entry</span></div>
<div class="line"><span class="keywordtype">int</span> sqlite3_yarts_init(sqlite3 *db, <span class="keywordtype">char</span> **pzErrMsg,</div>
<div class="line">                       <span class="keyword">const</span> sqlite3_api_routines *pApi) {</div>
<div class="line">    SQLITE_EXTENSION_INIT2(pApi);</div>
<div class="line">    <span class="comment">// oh yeah baby</span></div>
<div class="line">    <span class="keywordtype">int</span> rc = sqlite3_create_module(db, <span class="stringliteral">&quot;fetch&quot;</span>, &amp;fetch_vtab_module, 0);</div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="ttc" id="acommon_8h_html"><div class="ttname"><a href="common_8h.html">common.h</a></div><div class="ttdoc">General convenience functions for the other modules.</div></div>
<div class="ttc" id="acommon_8h_html_abf41691f50dd33bc178b7c1829b7d048"><div class="ttname"><a href="common_8h.html#abf41691f50dd33bc178b7c1829b7d048">str</a></div><div class="ttdeci">char str</div><div class="ttdef"><b>Definition:</b> common.h:36</div></div>
<div class="ttc" id="afetch_8h_html"><div class="ttname"><a href="fetch_8h.html">fetch.h</a></div><div class="ttdoc">Simplified Web Fetch implementation that wraps tcp socket code.</div></div>
<div class="ttc" id="afetch_8h_html_a585dd7049ee255d6147a22aee62a6b91"><div class="ttname"><a href="fetch_8h.html#a585dd7049ee255d6147a22aee62a6b91">fetch_pop</a></div><div class="ttdeci">char * fetch_pop(int fd, size_t *length)</div><div class="ttdef"><b>Definition:</b> fetch.c:285</div></div>
<div class="ttc" id="afetch_8h_html_ae2ade91c016425d325d49524ff3a218a"><div class="ttname"><a href="fetch_8h.html#ae2ade91c016425d325d49524ff3a218a">fetch</a></div><div class="ttdeci">int fetch(const char *url, struct fetch_init init)</div><div class="ttdef"><b>Definition:</b> fetch.c:116</div></div>
<div class="ttc" id="astructfetch__init_html"><div class="ttname"><a href="structfetch__init.html">fetch_init</a></div><div class="ttdef"><b>Definition:</b> fetch.h:27</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
